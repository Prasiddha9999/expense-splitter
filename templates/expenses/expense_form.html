{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if expense %}Edit Expense{% else %}Add Expense{% endif %} - Divider{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="text-center">{% if expense %}Edit Expense{% else %}Add Expense{% endif %} for {{ group.name }}</h2>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="expenseForm">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6">
                            <h4>Expense Details</h4>
                            {{ form.description|as_crispy_field }}
                            {{ form.amount|as_crispy_field }}
                            {{ form.currency|as_crispy_field }}
                            {{ form.date|as_crispy_field }}
                            {{ form.payer|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            <h4>Additional Information</h4>
                            {{ form.split_type|as_crispy_field }}
                            {{ form.receipt|as_crispy_field }}

                            <div id="converted-amount-container" class="mb-3 d-none">
                                <label class="form-label">Converted Amount</label>
                                <div id="converted-amount" class="form-control-plaintext"></div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <h4>Participants</h4>
                    <p class="text-muted">Select who's involved in this expense:</p>

                    <div class="participant-selector mb-4">
                        {% for member in group.members.all %}
                            <div class="participant-card" data-member-id="{{ member.id }}" data-username="{{ member.username }}">
                                <div class="member-circle">{{ member.username|first|upper }}</div>
                                <span>{{ member.username }}</span>
                            </div>
                        {% endfor %}
                    </div>

                    <div id="splits-container" class="d-none">
                        {{ formset.management_form }}

                        {% for split_form in formset %}
                            <div class="split-form d-none">
                                {{ split_form.participant }}
                                {{ split_form.amount }}
                                {% for hidden in split_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="alert alert-info" id="split-info">
                        <p>The expense will be split equally among all selected participants.</p>
                        <p id="split-amount-info">Each person will pay: <strong>0.00</strong></p>
                    </div>

                    <div class="form-group text-center mt-4">
                        <button class="btn btn-primary" type="submit">Save Expense</button>
                        <a href="{% url 'group-detail' group.id %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const totalAmount = document.getElementById('id_amount');
        const currencySelect = document.getElementById('id_currency');
        const convertedAmountContainer = document.getElementById('converted-amount-container');
        const convertedAmountDisplay = document.getElementById('converted-amount');
        const participantCards = document.querySelectorAll('.participant-card');
        const splitForms = document.querySelectorAll('.split-form');
        const totalFormsInput = document.getElementById('id_splits-TOTAL_FORMS');
        const splitAmountInfo = document.getElementById('split-amount-info').querySelector('strong');
        const expenseForm = document.getElementById('expenseForm');

        // Set split type to equal by default
        document.getElementById('id_split_type').value = 'equal';

        // Handle participant selection
        participantCards.forEach(card => {
            card.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateSplitForms();
            });

            // Select the current user by default
            if (card.dataset.username === document.getElementById('id_payer').value) {
                card.classList.add('selected');
            }
        });

        // Update split forms based on selected participants
        function updateSplitForms() {
            const selectedCards = document.querySelectorAll('.participant-card.selected');
            const selectedCount = selectedCards.length;

            // Update total forms
            totalFormsInput.value = selectedCount;

            // Calculate equal split amount
            const amount = parseFloat(totalAmount.value) || 0;
            const equalAmount = selectedCount > 0 ? (amount / selectedCount).toFixed(2) : 0;

            // Update split amount info
            const currencyCode = currencySelect.options[currencySelect.selectedIndex].text;
            splitAmountInfo.textContent = `${equalAmount} ${currencyCode}`;

            // Clear all forms first
            splitForms.forEach((form, index) => {
                const participantInput = form.querySelector('select[name$="-participant"]');
                const amountInput = form.querySelector('input[name$="-amount"]');

                participantInput.selectedIndex = -1;
                amountInput.value = '';
            });

            // Set values for selected participants
            selectedCards.forEach((card, index) => {
                if (index < splitForms.length) {
                    const form = splitForms[index];
                    const participantInput = form.querySelector('select[name$="-participant"]');
                    const amountInput = form.querySelector('input[name$="-amount"]');

                    // Set participant
                    const memberId = card.dataset.memberId;
                    for (let i = 0; i < participantInput.options.length; i++) {
                        if (participantInput.options[i].value == memberId) {
                            participantInput.selectedIndex = i;
                            break;
                        }
                    }

                    // Set amount
                    amountInput.value = equalAmount;
                }
            });
        }

        // Update split amounts when total amount changes
        totalAmount.addEventListener('input', function() {
            updateSplitForms();
            updateConvertedAmount();
        });

        // Currency conversion
        function updateConvertedAmount() {
            const amount = parseFloat(totalAmount.value) || 0;
            const currencyCode = currencySelect.options[currencySelect.selectedIndex].text;

            if (amount > 0 && currencyCode) {
                convertedAmountContainer.classList.remove('d-none');
                convertedAmountDisplay.textContent = `${amount} ${currencyCode}`;
            } else {
                convertedAmountContainer.classList.add('d-none');
            }
        }

        // Update when currency changes
        currencySelect.addEventListener('change', function() {
            updateSplitForms();
            updateConvertedAmount();
        });

        // Form submission validation
        expenseForm.addEventListener('submit', function(e) {
            const selectedCards = document.querySelectorAll('.participant-card.selected');
            if (selectedCards.length === 0) {
                e.preventDefault();
                alert('Please select at least one participant.');
                return false;
            }

            const amount = parseFloat(totalAmount.value);
            if (isNaN(amount) || amount <= 0) {
                e.preventDefault();
                alert('Please enter a valid amount.');
                return false;
            }

            return true;
        });

        // Initial calls
        updateSplitForms();
        updateConvertedAmount();
    });
</script>
{% endblock %}
